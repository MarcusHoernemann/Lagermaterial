<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materialliste Browser-Viewer (Ruhrbahn Design)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            /* Ruhrbahn Blau */
            background-color: #00305d; 
        }
        .material-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
        }
        .material-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border-color: #004b91;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #002548;
        }
        ::-webkit-scrollbar-thumb {
            background: #004b91;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #005eb8;
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="bg-slate-100 rounded-xl shadow-xl p-6 mb-8 border-b-4 border-yellow-400">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-black text-[#00305d] uppercase tracking-tight">Material-Viewer</h1>
                    <p class="text-slate-600 mb-4 font-medium">Wähle die Datei <span class="font-mono text-blue-700">Material.xlsx</span> aus.</p>
                </div>
                <button id="btn_reset" class="hidden text-xs bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition-colors font-bold shadow-sm">
                    Daten löschen
                </button>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <input type="file" id="input_file" class="block w-full text-sm text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-[#00305d] file:text-white hover:file:bg-[#004b91] cursor-pointer" accept=".xlsx, .xls" />
                
                <input type="text" id="search_input" placeholder="Suchen..." class="hidden w-full md:w-64 px-4 py-2 bg-white border-2 border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-[#00305d] focus:outline-none placeholder-slate-400" />
                
                <select id="filter_baugruppe" class="hidden w-full md:w-64 px-4 py-2 bg-white border-2 border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-[#00305d] focus:outline-none">
                    <option value="">Alle Baugruppen</option>
                </select>
            </div>
            
            <div id="error_msg" class="mt-4 text-red-700 font-bold hidden"></div>
        </div>

        <div id="info_bar" class="mb-4 text-white px-2 hidden flex justify-between items-center font-bold">
            <span id="item_count"></span>
            <span id="storage_info" class="text-xs bg-yellow-400 text-[#00305d] px-2 py-1 rounded shadow-sm hidden">Lokal gespeichert</span>
        </div>

        <div id="card_container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </div>

    <script>
        let allData = [];

        window.onload = function() {
            const cachedData = localStorage.getItem('materialData');
            if (cachedData) {
                try {
                    allData = JSON.parse(cachedData);
                    initInterface();
                    renderCards(allData);
                } catch (e) {
                    console.error("Fehler beim Laden des Speichers", e);
                }
            }
        };

        function initInterface() {
            document.getElementById('search_input').classList.remove('hidden');
            document.getElementById('filter_baugruppe').classList.remove('hidden');
            document.getElementById('info_bar').classList.remove('hidden');
            document.getElementById('btn_reset').classList.remove('hidden');
            populateBaugruppenFilter();
        }

        function populateBaugruppenFilter() {
            const filterSelect = document.getElementById('filter_baugruppe');
            filterSelect.innerHTML = '<option value="">Alle Baugruppen</option>';
            const baugruppen = [...new Set(allData.map(row => row[3]).filter(bg => bg))].sort();
            baugruppen.forEach(bg => {
                const option = document.createElement('option');
                option.value = bg;
                option.textContent = bg;
                filterSelect.appendChild(option);
            });
        }

        document.getElementById('btn_reset').addEventListener('click', function() {
            if(confirm("Möchtest du die gespeicherten Daten wirklich löschen?")) {
                localStorage.removeItem('materialData');
                location.reload();
            }
        });

        document.getElementById('input_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const errorDiv = document.getElementById('error_msg');
            errorDiv.classList.add('hidden');
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    if (rows.length < 2) {
                        errorDiv.textContent = "Die Datei scheint leer zu sein.";
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    allData = rows.slice(1).filter(row => row.length > 0);
                    localStorage.setItem('materialData', JSON.stringify(allData));
                    document.getElementById('storage_info').classList.add('hidden');
                    initInterface();
                    renderCards(allData);
                } catch (err) {
                    console.error(err);
                    errorDiv.textContent = "Fehler: " + err.message;
                    errorDiv.classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function applyFilters() {
            const searchTerm = document.getElementById('search_input').value.toLowerCase();
            const selectedBG = document.getElementById('filter_baugruppe').value;
            const filtered = allData.filter(row => {
                const matchesSearch = row.some(cell => String(cell).toLowerCase().includes(searchTerm));
                const matchesBG = selectedBG === "" || row[3] === selectedBG;
                return matchesSearch && matchesBG;
            });
            renderCards(filtered);
        }

        document.getElementById('search_input').addEventListener('input', applyFilters);
        document.getElementById('filter_baugruppe').addEventListener('change', applyFilters);

        function renderCards(rows) {
            const container = document.getElementById('card_container');
            const itemCount = document.getElementById('item_count');
            container.innerHTML = '';
            itemCount.textContent = `${rows.length} Materialien`;

            rows.forEach(row => {
                const bezeichnung = row[0] || '---';
                const matNr = row[1] || '---';
                const beschreibung = row[2] || 'Keine Beschreibung verfügbar';
                const baugruppe = row[3] || '---';

                const card = document.createElement('div');
                card.className = "material-card rounded-xl shadow-lg overflow-hidden flex flex-col p-5";
                
                card.innerHTML = `
                    <div class="flex justify-between items-center gap-4 mb-3">
                        <div class="text-xl font-black text-[#00305d] truncate" title="${bezeichnung}">
                            ${bezeichnung}
                        </div>
                        <div class="text-base font-mono font-black text-slate-800 bg-slate-300 px-3 py-1 rounded border border-slate-400 shadow-sm whitespace-nowrap">
                            Mat: ${matNr}
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 mb-4">
                        <div class="text-xs font-bold text-slate-700 bg-yellow-400 px-3 py-1 rounded shadow-sm flex items-center justify-center">
                            BG: ${baugruppe}
                        </div>
                    </div>

                    <div class="text-slate-700 text-sm font-medium italic line-clamp-3">
                        ${beschreibung}
                    </div>
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>